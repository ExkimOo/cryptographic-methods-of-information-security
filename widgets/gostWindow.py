# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'gostWindow.ui'
#
# Created by: PyQt5 UI code generator 5.15.4
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.
from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5.QtWidgets import QFileDialog
import docx
import fitz
from striprtf.striprtf import rtf_to_text

from cyphers.gost_cypher import GOST as Gost


class Ui_GOST(object):
    def setupUi(self, GOST):
        GOST.setObjectName("GOST")
        GOST.resize(751, 578)
        self.widget = QtWidgets.QWidget(GOST)
        self.widget.setGeometry(QtCore.QRect(30, 14, 691, 541))
        self.widget.setObjectName("widget")
        self.verticalLayout_2 = QtWidgets.QVBoxLayout(self.widget)
        self.verticalLayout_2.setContentsMargins(0, 0, 0, 0)
        self.verticalLayout_2.setObjectName("verticalLayout_2")
        self.cypherName = QtWidgets.QLabel(self.widget)
        font = QtGui.QFont()
        font.setPointSize(18)
        self.cypherName.setFont(font)
        self.cypherName.setAlignment(QtCore.Qt.AlignCenter)
        self.cypherName.setObjectName("cypherName")
        self.verticalLayout_2.addWidget(self.cypherName)
        self.input = QtWidgets.QTextEdit(self.widget)
        font = QtGui.QFont()
        font.setPointSize(14)
        self.input.setFont(font)
        self.input.setObjectName("input")
        self.verticalLayout_2.addWidget(self.input)
        self.horizontalLayout_3 = QtWidgets.QHBoxLayout()
        self.horizontalLayout_3.setObjectName("horizontalLayout_3")
        self.key = QtWidgets.QLineEdit(self.widget)
        font = QtGui.QFont()
        font.setPointSize(14)
        self.key.setFont(font)
        self.key.setFocusPolicy(QtCore.Qt.WheelFocus)
        self.key.setText("")
        self.key.setObjectName("key")
        self.horizontalLayout_3.addWidget(self.key)
        self.initVect = QtWidgets.QLineEdit(self.widget)
        font = QtGui.QFont()
        font.setPointSize(14)
        self.initVect.setFont(font)
        self.initVect.setObjectName("initVect")
        self.horizontalLayout_3.addWidget(self.initVect)
        self.verticalLayout_2.addLayout(self.horizontalLayout_3)
        self.horizontalLayout_4 = QtWidgets.QHBoxLayout()
        self.horizontalLayout_4.setObjectName("horizontalLayout_4")
        self.verticalLayout = QtWidgets.QVBoxLayout()
        self.verticalLayout.setObjectName("verticalLayout")
        self.horizontalLayout_2 = QtWidgets.QHBoxLayout()
        self.horizontalLayout_2.setObjectName("horizontalLayout_2")
        self.encrypt = QtWidgets.QPushButton(self.widget)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.encrypt.setFont(font)
        self.encrypt.setObjectName("encrypt")
        self.horizontalLayout_2.addWidget(self.encrypt)
        self.decrypt = QtWidgets.QPushButton(self.widget)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.decrypt.setFont(font)
        self.decrypt.setObjectName("decrypt")
        self.horizontalLayout_2.addWidget(self.decrypt)
        self.verticalLayout.addLayout(self.horizontalLayout_2)
        self.horizontalLayout = QtWidgets.QHBoxLayout()
        self.horizontalLayout.setObjectName("horizontalLayout")
        self.read = QtWidgets.QPushButton(self.widget)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.read.setFont(font)
        self.read.setObjectName("read")
        self.horizontalLayout.addWidget(self.read)
        self.write = QtWidgets.QPushButton(self.widget)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.write.setFont(font)
        self.write.setObjectName("write")
        self.horizontalLayout.addWidget(self.write)
        self.verticalLayout.addLayout(self.horizontalLayout)
        self.horizontalLayout_4.addLayout(self.verticalLayout)
        self.verticalLayout_3 = QtWidgets.QVBoxLayout()
        self.verticalLayout_3.setObjectName("verticalLayout_3")
        self.label_2 = QtWidgets.QLabel(self.widget)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.label_2.setFont(font)
        self.label_2.setAlignment(QtCore.Qt.AlignCenter)
        self.label_2.setObjectName("label_2")
        self.verticalLayout_3.addWidget(self.label_2)
        self.mode = QtWidgets.QComboBox(self.widget)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.mode.setFont(font)
        self.mode.setLayoutDirection(QtCore.Qt.LeftToRight)
        self.mode.setObjectName("mode")
        self.mode.addItem("")
        self.mode.addItem("")
        self.mode.addItem("")
        self.mode.addItem("")
        self.verticalLayout_3.addWidget(self.mode)
        self.horizontalLayout_4.addLayout(self.verticalLayout_3)
        self.verticalLayout_2.addLayout(self.horizontalLayout_4)
        self.output = QtWidgets.QTextEdit(self.widget)
        font = QtGui.QFont()
        font.setPointSize(14)
        self.output.setFont(font)
        self.output.setReadOnly(True)
        self.output.setObjectName("output")
        self.verticalLayout_2.addWidget(self.output)

        self.retranslateUi(GOST)
        QtCore.QMetaObject.connectSlotsByName(GOST)

        self.gost = Gost()
        self.textFromFile = None
        self.textToFile = None

        self.initVect.hide()
        self.key.setText('this_is_a_pasw_for_GOST_28147_89')

        self.encrypt.clicked.connect(self.encryptText)
        self.decrypt.clicked.connect(self.decryptText)
        self.mode.currentTextChanged.connect(self.toggleInitVect)

        self.read.clicked.connect(self.readFromFile)
        self.write.clicked.connect(self.writeToFile)

    def encryptText(self):
        encrypted_text = ''
        text = ''

        if self.textFromFile is None:
            text = self.input.toPlainText()
        else:
            text = self.textFromFile

        if self.mode.currentText() == 'ECB':
            encrypted_text = self.gost.ECB(text, self.key.text(), 'enc')
        elif self.mode.currentText() == 'CBC':
            encrypted_text = self.gost.CBC(text, self.key.text(), self.initVect.text(), 'enc')
        elif self.mode.currentText() == 'CFB':
            encrypted_text = self.gost.CFB(text, self.key.text(), self.initVect.text(), 'enc')
        elif self.mode.currentText() == 'OFB':
            encrypted_text = self.gost.OFB(text, self.key.text(), self.initVect.text(), 'enc')

        self.output.setText(encrypted_text)
        self.textFromFile = None
        self.textToFile = encrypted_text

    def decryptText(self):
        decrypted_text = ''
        text = ''

        if self.textFromFile is None:
            text = self.input.toPlainText()
        else:
            text = self.textFromFile

        if self.mode.currentText() == 'ECB':
            decrypted_text = self.gost.ECB(text, self.key.text(), 'dec')
        elif self.mode.currentText() == 'CBC':
            decrypted_text = self.gost.CBC(text, self.key.text(), self.initVect.text(), 'dec')
        elif self.mode.currentText() == 'CFB':
            decrypted_text = self.gost.CFB(text, self.key.text(), self.initVect.text(), 'dec')
        elif self.mode.currentText() == 'OFB':
            decrypted_text = self.gost.OFB(text, self.key.text(), self.initVect.text(), 'dec')

        self.output.setText(decrypted_text)
        self.textFromFile = None
        self.textToFile = decrypted_text

    def readFromFile(self):
        path = QFileDialog.getOpenFileName()[0]
        extension = path.split('/')[-1].split('.')[-1]

        if extension == 'txt':
            with open(path, 'r', encoding='koi8-r') as file:
                text = file.read()
                self.input.setText(text)
                self.textFromFile = text

        elif extension == 'docx':
            doc = docx.Document(path)
            text = []
            for para in doc.paragraphs:
                text.append(para.text)
            self.input.setText(''.join(text))

        elif extension == 'rtf':
            with open(path, 'r', encoding='koi8-r') as file:
                content = file.read()
                self.input.setText(rtf_to_text(content))
                self.textFromFile = rtf_to_text(content)

        elif extension == 'pdf':
            with fitz.open(path) as file:
                text = ''
                for page in file:
                    text += page.get_text()
                self.input.setText(rtf_to_text(text))

    def writeToFile(self):
        path = QFileDialog.getOpenFileName()[0]
        with open(path, 'w+', encoding='koi8-r') as file:
            text = ''

            if self.textToFile is None:
                text = self.input.toPlainText()
            else:
                text = self.textToFile

            file.write(text)

        self.textToFile = None

    def toggleInitVect(self):
        if self.mode.currentText() == 'ECB':
            self.initVect.hide()
        else:
            self.initVect.show()

    def retranslateUi(self, GOST):
        _translate = QtCore.QCoreApplication.translate
        GOST.setWindowTitle(_translate("GOST", "GOST"))
        self.cypherName.setText(_translate("GOST", "ГОСТ 28147-89"))
        self.key.setPlaceholderText(_translate("GOST", "Ключ (32 символа)"))
        self.initVect.setPlaceholderText(_translate("GOST", "Вектор инициализации (8 символов)"))
        self.encrypt.setText(_translate("GOST", "Зашифровать"))
        self.decrypt.setText(_translate("GOST", "Расшифровать"))
        self.read.setText(_translate("GOST", "Открыть файл"))
        self.write.setText(_translate("GOST", "Записать в файл"))
        self.label_2.setText(_translate("GOST", "Режим шифрования:"))
        self.mode.setItemText(0, _translate("GOST", "ECB"))
        self.mode.setItemText(1, _translate("GOST", "CBC"))
        self.mode.setItemText(2, _translate("GOST", "CFB"))
        self.mode.setItemText(3, _translate("GOST", "OFB"))
